name: Build Universal Proxy APK

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Create Gradle configuration
      run: |
        # Create minimal build files
        cat > build.gradle << 'EOF'
        plugins {
            id 'com.android.application' version '8.0.2' apply false
        }
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF
        
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "UniversalProxy"
        include ':app'
        EOF
        
        cat > app/build.gradle << 'EOF'
        plugins {
            id 'com.android.application'
        }
        android {
            namespace 'com.yourname.universalproxy'
            compileSdk 34
            defaultConfig {
                applicationId "com.yourname.universalproxy"
                minSdk 21
                targetSdk 34
                versionCode 1
                versionName "1.0"
            }
            buildTypes {
                release {
                    minifyEnabled false
                }
            }
        }
        dependencies {
            implementation 'androidx.appcompat:appcompat:1.6.1'
        }
        EOF
        
    - name: Build APK
      run: ./gradlew assembleRelease
      
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: universal-proxy-apk
        path: app/build/outputs/apk/release/*.apk
        retention-days: 1
